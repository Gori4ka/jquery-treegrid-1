!function(e){function t(t){var n=e(this),a=e.extend({},e.fn.treegrid.defaults,t);return n.each(function(){var t=e(this);t.data("treegrid-settings",a),t.on("click",">tbody>tr>td:first-child>.treegrid-container>.treegrid-expander",h).on("mousedown",">tbody>tr>td:first-child>.treegrid-container",v),f(E.getRoots.call(t),1)})}function n(t){var n=t.closest("table").data("treegrid-settings");n.onExpand.call(t)&&(t.addClass("expanded"),t.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-collapsed").addClass("treegrid-expander-expanded"),o(t).not(t).each(function(){var t=e(this);g(t)?t.hide():t.show()}))}function a(e){var t=e.closest("table").data("treegrid-settings");t.onCollapse.call(e)&&(e.removeClass("expanded"),e.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-expanded").addClass("treegrid-expander-collapsed"),o(e).not(e).hide())}function r(t,n){var a,r=o(t).last().next(),i=[],d=s(t),l=t;"TABLE"!==l.prop("tagName")&&(l=l.closest("table")),a=l.find(">thead>tr,>tbody>tr").first().find(">th,>td").length,e.each(n,function(t,n){var o=e(n);if(!l.find(">tbody>tr.treegrid-"+s(o)).length){null!==d&&o.addClass("treegrid-parent-"+d);var c=o.find(">td").length;if(a>c)for(var t=o.find(">td").length;a>t;t++)o.append("<td>");else c>a&&o.find(">td").eq(a-1).nextAll().remove();r.length?o.insertBefore(r):l.find(">tbody").append(o),i.push(o[0])}}),i=e(i),null===d&&f(i),f(t,t.data("treegrid-depth"));var c=t.closest("table").data("treegrid-settings");c.onAdd.call(t,i)}function i(e){return e.parent().find(">.treegrid-"+l(e))}function d(e){return e.parent().find(">.treegrid-parent-"+s(e))}function o(t){var n=t;return"TR"!==t.prop("tagName")?n.not(t):(d(t).each(function(){n=n.add(o(e(this)))}),n)}function s(e){var t=/treegrid-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function l(e){var t=/treegrid-parent-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function c(e){return e.data("count")&&!e.hasClass("expanded")}function u(e){return e.data("count")&&e.hasClass("expanded")}function f(t,n,a){void 0===n&&(n=1),t.each(function(){var t=e(this).data("treegrid-depth",n),r=d(t),i=r.length;void 0===t.data("count")||t.data("loaded")||t.data("count")==i?t.data("loadNeeded")||(t.data({loaded:!0,count:i}),i&&a&&t.addClass("expanded")):t.data("loadNeeded",!0),$td=t.find(">td:first"),$container=$td.find(">.treegrid-container"),0===$container.length&&($container=e('<div class="treegrid-container">').html($td.html()),$td.html("").append($container)),$container.find(".treegrid-expander").remove(),$expander=e('<span class="treegrid-expander">').prependTo($container),t.data("count")&&(t.hasClass("expanded")?$expander.addClass("treegrid-expander-expanded"):$expander.addClass("treegrid-expander-collapsed")),$container.css("marginLeft",n*$expander.width()),g(t)&&t.hide(),f(r,n+1,a)})}function h(){var t=e(this);(t.hasClass("treegrid-expander-expanded")||t.hasClass("treegrid-expander-collapsed"))&&E.toggle.call(t.closest("tr"))}function g(e){if(null===l(e))return!1;var t=i(e);return c(t)?!0:g(t)}function p(t){var n=t.closest("table").data("treegrid-settings");return o(t).not(t).remove(),e.isFunction(n.source)&&!t.hasClass("loading")&&(t.addClass("loading"),n.source.call(t,s(t),function(e){t.removeData("loadNeeded").data("loaded",!0),r(t,e),t.removeClass("loading"),E.expand.call(t)})),"string"!==e.type(n.source)||t.hasClass("loading")||(t.addClass("loading"),e.post(n.source,{id:s(t)},function(e){t.removeDate("loadNeeded").data("loaded",!0),r(t,e),t.removeClass("loading")},"json")),!1}function v(t){if(0===t.button){var n=e(this),a=n.closest("table").data("treegrid-settings");if(a.enableMove){var r=e(t.target);if(!r.hasClass("treegrid-expander")&&(a.moveHandle===!1||n.find(a.moveHandle)[0]==r[0])){S=n.closest("tr"),N=t.pageX,Y=t.pageY;var i=n.offset();return X=i.left-t.pageX,j=i.top-t.pageY,e(document).on("mouseup",m).on("mousemove",x),!1}}}}function m(t){H&&$(),e(document).off("mouseup",m).off("mousemove",x)}function x(e){var t=Math.max(Math.abs(e.pageX-N),Math.abs(e.pageY-Y)),n=S.closest("table").data("treegrid-settings");t>=n.moveDistance&&!H?b(e):H&&C(e)}function b(t){if(H=!0,T(),B=S.find(">td:first>.treegrid-container").clone().addClass("dragging").css({left:t.pageX+X,top:t.pageY+j}),B.find(">.treegrid-expander").remove(),B.appendTo("body"),!e(".treegrid-move-indicator").length){A=e('<div class="treegrid-move-indicator">').appendTo("body");var n=S.closest("table"),a=n.data("treegrid-settings");a.onMoveStart.call(n,S,B)}}function C(t){B.css({left:t.pageX+X,top:t.pageY+j});var n=null;e.each(O,function(e,a){return t.pageX>=a[0]&&t.pageY>=a[1]&&t.pageX<=a[0]+a[2]&&t.pageY<=a[1]+a[3]?(y(t,a)&&(n=a[4]),!1):void 0}),null!==F&&n!==F&&M(null==n),F=n}function $(){H=!1;var e=S.closest("table"),t=e.data("treegrid-settings");t.onMoveStop.call(e,S,B),B.remove(),A.remove(),R!==!1&&(window.clearTimeout(R),R=!1),null!==F&&w()}function y(e,t){var n,a,r=t[3]/4,i=3*r,d=e.pageY-t[1];if(r>d?(n=t[1],a=0):d>=i?(n=t[1]+t[3],a=2):(n=t[1]+t[3]/2,a=1),t[4]==F&&a==D)return!0;if(null===s(t[4]))return!1;var o=t[4];1==a?R===!1&&c(o)&&(R=window.setTimeout(function(){E.expand.call(o),R=!1},500)):R!==!1&&(window.clearTimeout(R),R=!1);var l=S.closest("table"),u=l.data("treegrid-settings");return u.onMoveOver.call(l,S,B,t[4],a)?(A.css({display:"block",left:t[4].find(">td:first>.treegrid-container").offset().left,top:n}),D=a,!0):!1}function M(e){var t=S.closest("table"),n=t.data("treegrid-settings");n.onMoveOut.call(t,S,B,F),e&&A.hide(),R!==!1&&(window.clearTimeout(R),R=!1)}function w(){M(!0);var e=S.closest("table"),t=e.data("treegrid-settings"),n=t.onMove.call(e,S,F,D);n!==!1&&E.move.call(S,F,D)}function T(){var t=[];o(S).each(function(){t.push(s(e(this)))}),O=[],S.parent().find("tr").each(function(){var n=e(this);if(-1===e.inArray(s(n),t)){var a=n.offset();O.push([a.left,a.top,n.width(),n.height(),n])}})}e.fn.treegrid=function(n){return E[n]?E[n].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof n&&n?void e.error("Method with name "+n+" does not exists for jQuery.treegrid"):t.apply(this,arguments)},e.fn.treegrid.defaults={source:null,enableMove:!1,moveDistance:10,moveHandle:!1,onExpand:function(){return!0},onCollapse:function(){return!0},onAdd:function(){},onMoveStart:function(){},onMoveStop:function(){},onMoveOver:function(){return!0},onMoveOut:function(){},onMove:function(){return!0}};var A,N,Y,X,j,O,D,E={option:function(t,n){var a=this.data("treegrid-settings");return"string"===e.type(t)&&void 0!==n&&(t={optionName:n}),e.isPlainObject(t)?(a=e.extend({},a,t),this.data("treegrid-settings",a)):"string"===e.type(t)?a[t]:a},getId:function(){return s(this)},toggle:function(){return this.each(function(){$this=e(this),u($this)?E.collapse.call($this):c($this)&&E.expand.call($this)})},expand:function(){var t=!1;return this.each(function(){var a=e(this);c(a)&&(a.data("loaded")||p(a))&&(n(a),t=!0)}),H&&T(),this},collapse:function(){var t=!1;return this.each(function(){var n=e(this);u(n)&&(a(n),t=!0)}),H&&T(),this},add:function(t){return this.each(function(){r(e(this),t)}),H&&T(),this},remove:function(){return this.each(function(){var t=e(this),n=i(t);o(t).remove(),f(n,n.data("treegrid-depth"))}),H&&T(),this},move:function(e,t){var n,a,r=i(this);n=0==t?e.prev():o(e).last(),a=1===t?s(e):l(e),this.removeClass("treegrid-parent-"+l(this)),null!==a&&this.addClass("treegrid-parent-"+a),$branch=o(this),n.length?$branch.insertAfter(n):$branch.prependTo(this.parent()),g(this)&&$branch.hide(),r.length&&f(r,r.data("treegrid-depth"));var d=i(this);d.length?f(d,d.data("treegrid-depth")):f(this)},getRoots:function(){var t=[];return this.find(">tbody>tr").each(function(){null===l(e(this))&&t.push(this)}),e(t)},getChildNodes:function(){var t=e();return this.each(function(){t=t.add(d(e(this)))}),t},getBranch:function(){var t=e();return this.each(function(){t=t.add(o(e(this)))}),t},getParent:function(){var t=e();return this.each(function(){t=t.add(i(e(this)))}),t},isCollapsed:function(){var t=!1;return this.each(function(){return t=c(e(this)),t?!1:void 0}),t},isExpanded:function(){var t=!1;return this.each(function(){return t=u(e(this)),t?!1:void 0}),t}},S=null,B=null,F=null,H=!1,R=!1}(jQuery);
!function(e){function t(t){var n=e(this),a=e.extend({},e.fn.treegrid.defaults,t);return n.each(function(){var t=e(this);t.data("treegrid-settings",a),t.on("click",">tbody>tr>td:first-child>.treegrid-container>.treegrid-expander",h).on("mousedown",">tbody>tr>td:first-child>.treegrid-container",v),f(B.getRoots.call(t),1)})}function n(t){var n=t.closest("table").data("treegrid-settings");n.onExpand.call(t)&&(t.addClass("expanded"),t.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-collapsed").addClass("treegrid-expander-expanded"),o(t).not(t).each(function(){var t=e(this);p(t)?t.hide():t.show()}))}function a(e){var t=e.closest("table").data("treegrid-settings");t.onCollapse.call(e)&&(e.removeClass("expanded"),e.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-expanded").addClass("treegrid-expander-collapsed"),o(e).not(e).hide())}function r(t,n){var a,r=o(t).last().next(),i=[],d=s(t),l=t;"TABLE"!==l.prop("tagName")&&(l=l.closest("table")),a=l.find("tr:first>th,tr:first>td").length,e.each(n,function(t,n){var o=e(n),s=o.find(">td").length;if(null!==d&&o.addClass("treegrid-parent-"+d),a>s)for(var t=o.find(">td").length;a>t;t++)o.append("<td>");else s>a&&o.find(">td").eq(a-1).nextAll().remove();r.length?o.insertBefore(r):l.find("tbody").append(o),i.push(o[0])}),i=e(i),null===d&&f(i),f(t,t.data("depth"));var c=t.closest("table").data("treegrid-settings");c.onAdd.call(t,i)}function i(e){return e.parent().find(">.treegrid-"+l(e))}function d(e){return e.parent().find(">.treegrid-parent-"+s(e))}function o(t){var n=t;return"TR"!==t.prop("tagName")?n.not(t):(d(t).each(function(){n=n.add(o(e(this)))}),n)}function s(e){var t=/treegrid-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function l(e){var t=/treegrid-parent-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function c(e){return e.data("count")&&!e.hasClass("expanded")}function u(e){return e.data("count")&&e.hasClass("expanded")}function f(t,n,a){void 0===n&&(n=1),t.each(function(){var t=e(this).data("depth",n),r=d(t);if(void 0===t.data("count")||t.data("loaded")){var i=r.length;t.data({loaded:!0,count:i}),i&&a&&t.addClass("expanded")}$td=t.find(">td:first"),$container=$td.find(">.treegrid-container"),0===$container.length&&($container=e('<div class="treegrid-container">').html($td.html()),$td.html("").append($container)),$container.find(".treegrid-expander").remove(),$expander=e('<span class="treegrid-expander">').prependTo($container),t.data("count")&&(t.hasClass("expanded")?$expander.addClass("treegrid-expander-expanded"):$expander.addClass("treegrid-expander-collapsed")),$container.css("marginLeft",n*$expander.width()),p(t)&&t.hide(),f(r,n+1,a)})}function h(){var t=e(this);(t.hasClass("treegrid-expander-expanded")||t.hasClass("treegrid-expander-collapsed"))&&B.toggle.call(t.closest("tr"))}function p(e){if(null===l(e))return!1;var t=i(e);return c(t)?!0:p(t)}function g(t){var n=t.closest("table").data("treegrid-settings");if(o(t).not(t).remove(),e.isFunction(n.source)){var a=n.source.call(t,s(t));if(e.isArray(a))return t.data("loaded",!0),r(t,a),!0}return"string"!==e.type(n.source)||t.hasClass("loading")||(t.addClass("loading"),e.post(n.source,{id:s(t)},function(e){t.data("loaded",!0),r(t,e),t.removeClass("loading")},"json")),!1}function v(t){if(0===t.button){var n=e(this),a=n.closest("table").data("treegrid-settings");if(a.enableMove){var r=e(t.target);if(!r.hasClass("treegrid-expander")&&(a.moveHandle===!1||n.find(a.moveHandle)[0]==r[0])){F=n.closest("tr"),Y=t.pageX,X=t.pageY;var i=n.offset();return j=i.left-t.pageX,E=i.top-t.pageY,e(document).on("mouseup",m).on("mousemove",x),!1}}}}function m(t){R&&$(),e(document).off("mouseup",m).off("mousemove",x)}function x(e){var t=Math.max(Math.abs(e.pageX-Y),Math.abs(e.pageY-X)),n=F.closest("table").data("treegrid-settings");t>=n.moveDistance&&!R?b(e):R&&C(e)}function b(t){if(R=!0,A(),H=F.find(">td:first>.treegrid-container").clone().addClass("dragging").css({left:t.pageX+j,top:t.pageY+E}),H.find(">.treegrid-expander").remove(),H.appendTo("body"),!e(".treegrid-move-indicator").length){T=e('<div class="treegrid-move-indicator">').appendTo("body");var n=F.closest("table"),a=n.data("treegrid-settings");a.onMoveStart.call(n,F,H)}}function C(t){H.css({left:t.pageX+j,top:t.pageY+E});var n=null;e.each(O,function(e,a){return t.pageX>=a[0]&&t.pageY>=a[1]&&t.pageX<=a[0]+a[2]&&t.pageY<=a[1]+a[3]?(y(t,a)&&(n=a[4]),!1):void 0}),null!==N&&n!==N&&M(null==n),N=n}function $(){R=!1;var e=F.closest("table"),t=e.data("treegrid-settings");t.onMoveStop.call(e,F,H),H.remove(),T.remove(),k!==!1&&(window.clearTimeout(k),k=!1),null!==N&&w()}function y(e,t){var n,a,r=t[3]/4,i=3*r,d=e.pageY-t[1];if(r>d?(n=t[1],a=0):d>=i?(n=t[1]+t[3],a=2):(n=t[1]+t[3]/2,a=1),t[4]==N&&a==S)return!0;if(1==a&&null===s(t[4]))return!1;var o=t[4];c(o)&&k===!1&&(k=window.setTimeout(function(){B.expand.call(o),k=!1},500));var l=F.closest("table"),u=l.data("treegrid-settings");return u.onMoveOver.call(l,F,H,t[4],a)?(T.css({display:"block",left:t[4].find(">td:first>.treegrid-container").offset().left,top:n}),S=a,!0):!1}function M(e){var t=F.closest("table"),n=t.data("treegrid-settings");n.onMoveOut.call(t,F,H,N),e&&T.hide(),k!==!1&&(window.clearTimeout(k),k=!1)}function w(){M(!0);var e=F.closest("table"),t=e.data("treegrid-settings"),n=t.onMove.call(e,F,N,S);n!==!1&&B.move.call(F,N,S)}function A(){var t=[];o(F).each(function(){t.push(s(e(this)))}),O=[],F.parent().find("tr").each(function(){var n=e(this);if(-1===e.inArray(s(n),t)){var a=n.offset();O.push([a.left,a.top,n.width(),n.height(),n])}})}var T,Y,X,j,E,O,S,B={toggle:function(){return this.each(function(){$this=e(this),u($this)?B.collapse.call($this):c($this)&&B.expand.call($this)})},expand:function(){var t=!1;return this.each(function(){var a=e(this);c(a)&&(a.data("loaded")||g(a))&&(n(a),t=!0)}),R&&A(),this},collapse:function(){var t=!1;return this.each(function(){var n=e(this);u(n)&&(a(n),t=!0)}),R&&A(),this},add:function(t){return this.each(function(){r(e(this),t)}),R&&A(),this},remove:function(){return this.each(function(){var t=e(this),n=i(t);o(t).remove(),f(n,n.data("depth"))}),R&&A(),this},move:function(e,t){var n,a,r=i(this);n=0==t?e.prev():o(e).last(),a=1===t?s(e):l(e),this.removeClass("treegrid-parent-"+l(this)),null!==a&&this.addClass("treegrid-parent-"+a),$branch=o(this),n.length?$branch.insertAfter(n):$branch.prependTo(this.parent()),p(this)&&$branch.hide(),r.length&&f(r,r.data("depth"));var d=i(this);d.length?f(d,d.data("depth")):f(this)},getRoots:function(){var t=[];return this.find(">tbody>tr").each(function(){null===l(e(this))&&t.push(this)}),e(t)},getChildNodes:function(){var t=e();return this.each(function(){t=t.add(d(e(this)))}),t},getBranch:function(){var t=e();return this.each(function(){t=t.add(o(e(this)))}),t},getParent:function(){var t=e();return this.each(function(){t=t.add(i(e(this)))}),t},isCollapsed:function(){var t=!1;return this.each(function(){return t=c(e(this)),t?!1:void 0}),t},isExpanded:function(){var t=!1;return this.each(function(){return t=u(e(this)),t?!1:void 0}),t}},F=null,H=null,N=null,R=!1,k=!1;e.fn.treegrid=function(n){return B[n]?B[n].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof n&&n?void e.error("Method with name "+n+" does not exists for jQuery.treegrid"):t.apply(this,arguments)},e.fn.treegrid.defaults={source:null,enableMove:!1,moveDistance:10,moveHandle:!1,onExpand:function(){return!0},onCollapse:function(){return!0},onAdd:function(){},onMoveStart:function(){},onMoveStop:function(){},onMoveOver:function(){return!0},onMoveOut:function(){},onMove:function(){return!0}}}(jQuery);